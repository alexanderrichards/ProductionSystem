<!doctype html>
<html lang="en">
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous"/>
  <!-- open-iconic-bootstrap (icon set for bootstrap) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.1/font/css/open-iconic-bootstrap.min.css" integrity="sha256-BJ/G+e+y7bQdrYkS2RBTyNfBHpA9IuGaPmf9htub5MQ=" crossorigin="anonymous"/>
  <!-- Datatables -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.1/css/bootstrap.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css"/>
  <!-- FancyBox -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.css"/>
  <style>
    #context_menu { display: none; }
    .fancybox-slide--iframe .fancybox-content {
	  width  : 800px;
	  height : 600px;
	  max-width  : 80%;
	  max-height : 80%;
	  margin: 0;
    }
  </style>


  <title>{% block title %}Production System{% endblock %}</title>
</head>

<body class="mx-auto w-75">
<div id="notification" class="fixed-top mx-auto w-75"></div>


<nav class="navbar navbar-dark bg-primary text-light justify-content-between shadow">
  <h1>{% block heading %}Production System{% endblock %}</h1>
  <div class="w-50 d-flex justify-content-end">
    <h6 class="my-auto mr-3">{{ user.dn }}</h6>
    <img id="identicon" class="img-fluid rounded-circle" src="https://www.gravatar.com/avatar/{{ user.email| gravitar_hash }}?d=identicon" style="height: 60px">
  </div>
</nav>
<nav class="navbar navbar-light bg-light justify-content-end border shadow rounded-bottom mb-5">
  <img alt="Monitoring daemon status" class="my-auto mx-1" src="{{monitoringd_service| service_badge_url('monitoringd')}}">
  <img alt="DIRAC status" class="my-auto mx-1" src="{{dirac_service| service_badge_url('DIRAC')}}">
  {% if user.admin %}
  <a class="btn btn-outline-primary" data-fancybox data-type="iframe" data-src="/admins" data-caption="Admin Management" href="javascript:;" role="button">
    <span class="oi oi-person"></span>
    Admins
  </a>
  {% endif %}
</nav>

<!--
    <div class="pt-3 d-flex justify-content-end">
      <h5 class="my-auto">{{ user.dn }}</h5>
      <img id="identicon" class="rounded-circle" src="https://www.gravatar.com/avatar/{{ user.email| gravitar_hash }}?d=identicon">
    </div>
    <div class="d-flex justify-content-start">
      <h1>Production System</h1>
    </div>

    <div class="my-4 d-flex justify-content-end">
      <button type="button" class="btn btn-outline-primary">
	<span class="oi oi-person"></span>
	Admins
      </button>
    </div>
-->

<div id="context_menu" class="dropdown-menu">
  <h6 class="dropdown-header"></h6>
  <div class="dropdown-divider"></div>
  <button id="context_info" class="dropdown-item btn btn-primary text-primary" type="button">
      <span class="oi oi-info"></span>
      Info
  </button>
  {% if user.admin %}
  <button id="context_approve" class="dropdown-item btn btn-success text-success" type="button">
      <span class="oi oi-thumb-up"></span>
      Approve
  </button>
  <button id="context_remove" class="dropdown-item btn btn-danger text-danger" type="button">
      <span class="oi oi-trash"></span>
      Remove
  </button>
  {% endif %}
</div>

<table id="requests_table" class="table table-striped mx-auto w-100"></table>

<div class="d-flex justify-content-start mt-4">
  <a class="btn btn-primary mr-1" data-fancybox data-type="iframe" data-src="/newrequest" data-caption="New Request Form" href="javascript:;" role="button">
    <span class="oi oi-plus"></span>
    New Request
  </a>
  <button type="button" class="btn btn-outline-primary ml-1">
    <span class="oi oi-cloud-download"></span>
    Export
  </button>
</div>

<hr>

<div class="d-flex justify-content-end">
  <a class="btn btn-light text-primary border" href="{% block report_url %}https://github.com/alexanderrichards/ProductionSystem/issues{% endblock %}" role="button">
    <span class="oi oi-bullhorn"></span>
    Report a problem
  </a>
</div>



<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<!-- DataTables -->
<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>
<!-- FancyBox -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.js"></script>
<script src="utils.js"></script>
<script>
$(document).ready(function(){

  var requests_table = $("#requests_table");

  console.debug("Getting requests.");
  requests_table.DataTable({
    "ajax": {"url": "/api/requests", "cache": true, "dataSrc": '',
             "error": function(jqXHR, textStatus, errorThrown){
                console.error(`Failed to get requests.\n--------\nStatus: ${textStatus}\nError: ${errorThrown}\n--------\n${jqXHR.responseText}`);
                bootstrap_alert("danger", "ERROR:", "Failed to get requests!");
             }},
    "order": [[1, "asc"]],
    "columns": [
        {% block requests_table_columns %}
        { "data": null, "orderable": false, "width": "5%", "defaultContent": '<span class="oi oi-chevron-bottom text-primary parametricjobs_toggle"></span>'},
        { "title": "ID", "data": "id", "className": "request_id", "width": "5%" },
        { "title": "Description", "data": "description", "width": "60%" },
        { "title": "Status", "data": "status", "width": "5%" },
        { "title": "Date Requested", "data": "request_date", "width": "15%" },
        { "title": "Requester", "data": "requester.name", "width": "10%" },
        {% endblock%}
    ]
  });

  requests_table.on("click", "tbody tr", function(){
    $(this).toggleClass("bg-primary text-light");
    $(this).find("span.parametricjobs_toggle").toggleClass("text-light");
  });

  requests_table.on("click", "span.parametricjobs_toggle", function(){
    var parametricjobs_toggle = $(this);
    parametricjobs_toggle.toggleClass("text-primary text-danger oi-chevron-bottom oi-chevron-top");

    var tr = parametricjobs_toggle.closest('tr');
    var row = requests_table.DataTable().row(tr);
    if ( row.child.isShown() ) {
      // This row is already open - close it
      row.child.hide();
      tr.removeClass('shown');
      return;
    }

    var subtable = $("<table/>", {"class": "table table-striped mx-auto w-100"});
    var request_id = tr.find("td.request_id").text();
    console.debug(`Getting parametric jobs for request ${request_id}`)
    subtable.DataTable({
        "ajax": {"url": `/api/requests/${request_id}/parametricjobs`, "cache": true,
                 "dataSrc": function(data){
                    $.each(data, function(index, element){
                        element.id = `${request_id}.${element.id}`;
                    });
                    return data;
                 },
                 "error": function(jqXHR, textStatus, errorThrown){
                    console.error(`Failed to get parametric jobs for request ${request_id}.\n--------\nStatus: ${textStatus}\nError: ${errorThrown}\n--------\n${jqXHR.responseText}`);
                    bootstrap_alert("danger", "ERROR:", `Failed to get parametricjobs for request ${request_id}`);
                 },
                 "statusCode": {
                    400: function(){
                        console.warn(`Request id ${request_id} is not valid.`)
                        bootstrap_alert("warning", "Attention:", `Request id ${request_id} is not valid.`)
                    }
                 }},
        "order": [[0, "asc"]],
        "columns": [
            {% block parametricjobs_table_columns %}
            { "title": "ID", "data": "id", "width": "50%" },
            { "title": "Status", "data": "status", "width": "50%" },
            {% endblock %}
        ]
    });
    row.child(subtable).show();
    tr.addClass('shown');

  });

  var context_menu = $("#context_menu");
  var context_menu_request_id = '0';
  var context_menu_header = context_menu.children(".dropdown-header");
  context_menu.contextmenu(function(){ return false; });

  requests_table.on("contextmenu", "tbody tr", function(event){
    var request_id = $(this).find("td.request_id").text();
    var selected_rows = requests_table.find("tbody tr.text-light td.request_id");
    var selected_ids = [];
    selected_rows.each(function(index, cell){
      selected_ids.push($(this).text());
    });

    if ($.inArray(request_id, selected_ids) === -1){
      selected_rows.trigger("click");
      selected_rows = [];
      selected_ids = [];
    }

    if (context_menu.hasClass("shown")){
      $("html").trigger("click");
      return false;
    }

    context_menu_request_id = request_id
    if (selected_rows.length > 1){
      context_menu_header.text("Bulk actions for requests");
    }
    else{
      context_menu_header.text(`Actions for request ${request_id}`);
    }
    context_menu.css({
        top: event.pageY,
        left: event.pageX
    });
    context_menu.show();
    context_menu.addClass("shown");
    return false;  // Suppress browser contextmenu
  });

  $("html").click(function(){
    context_menu.hide();
    context_menu.removeClass("shown");
  });

  $("html").contextmenu(function(){
    context_menu.hide();
    context_menu.removeClass("shown");
    return true;
  });

  {% if user.admin %}
  $("#context_approve").click(function(){

    var ids = [];
    var selected_rows = requests_table.find("tbody tr.text-light td.request_id");
    selected_rows.each(function(index, cell){
      ids.push($(this).text());
    });

    if (ids.length === 0){
      ids = [context_menu_request_id];
    }

    ajax_calls = [];
    $.each(ids, function(index, id){
      ajax_calls.push(
        $.ajax({
          url: `/api/requests/${id}`,
          type: "PUT",
          data: {status: "Approved"},
          success: function(){
            console.log(`Approved request ${id}`);
          },
          error: function(jqXHR, textStatus, errorThrown){
            console.error(`Error approving request ${id}.\n--------\nStatus: ${textStatus}\nError: ${errorThrown}\n--------\n${jqXHR.responseText}`);
          },
          statusCode: {  // Since these menu items should only be available when jinja renders the admin page, 401 and 403 should not happen.
            400: function(){
              console.warn("Only jobs in Requested may transition to Approved.");
            },
            401: function(){
              console.warn("Unauthorised delete request.");
            },
            403: function(){
              console.error("Delete request is forbidden for current user.");
            }
          }
        })
      );
    });
    $.when.apply(this, ajax_calls).then(
      function(){
        bootstrap_alert("success", "Approved:", `Successfully removed ${ids.length} requests.`);
        requests_table.DataTable().ajax.reload();
      },
      function(){
        bootstrap_alert("danger", "Failed:", "Request approval failed. Please check the console log.");
        requests_table.DataTable().ajax.reload();
      }
    );
  });

  $("#context_remove").click(function(){

    var ids = [];
    var selected_rows = requests_table.find("tbody tr.text-light td.request_id");
    selected_rows.each(function(index, cell){
      ids.push($(this).text());
    });

    if (ids.length === 0){
      ids = [context_menu_request_id];
    }

    ajax_calls = [];
    $.each(ids, function(index, id){
      ajax_calls.push(
        $.ajax({
          url: `/api/requests/${id}`,
          type: "DELETE",
          success: function(){
            console.log(`Removed request ${id}`);
          },
          error: function(jqXHR, textStatus, errorThrown){
            console.error(`Error removing request ${id}.\n--------\nStatus: ${textStatus}\nError: ${errorThrown}\n--------\n${jqXHR.responseText}`);
          },
          statusCode: {  // Since these menu items should only be available when jinja renders the admin page this should not happen.
            401: function(){
              console.warn("Unauthorised delete request.");
            },
            403: function(){
              console.error("Delete request is forbidden for current user.");
            }
          }
        })
      );
    });
    $.when.apply(this, ajax_calls).then(
      function(){
        bootstrap_alert("success", "Removed:", `Successfully removed ${ids.length} requests.`);
        requests_table.DataTable().ajax.reload();
      },
      function(){
        bootstrap_alert("danger", "Failed:", "Request removal failed. Please check the console log.");
        requests_table.DataTable().ajax.reload();
      }
    );
  });
  {% endif %}
});
</script>
</body>
</html>
